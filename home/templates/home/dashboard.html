<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>ZeroOverflow AI - Central Command Dashboard</title>
    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Leaflet Map CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Montserrat:wght@700;800&display=swap" rel="stylesheet">
    
    <style>
        :root {
            /* ORIGINAL TEAL THEME */
            --primary-color: #2a9d8f; 
            --primary-dark: #1d6f65;
            --secondary-color: #264653; 
            --danger-color: #e76f51;
            --warning-color: #e9c46a; 
            --success-color: #2a9d8f;
            --light-bg: #f8f9fa;
            --card-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
            --transition: all 0.3s ease;
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Poppins', sans-serif; background-color: #f5f7fb; color: #333; min-height: 100vh; }
        
        /* HEADER */
        .dashboard-header {
            background: linear-gradient(135deg, var(--secondary-color) 0%, #1a3340 100%);
            color: white; padding: 15px 0; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            position: sticky; top: 0; z-index: 1000;
        }
        .logo-text { font-family: 'Montserrat', sans-serif; font-weight: 800; font-size: 1.6rem; letter-spacing: 0.5px; }
        .admin-badge { background: rgba(255,255,255,0.15); padding: 5px 12px; border-radius: 4px; font-size: 0.8rem; text-transform: uppercase; letter-spacing: 1px; margin-left: 15px; }

        /* TABS */
        .nav-link { color: rgba(255, 255, 255, 0.8); border: none; font-weight: 500; padding: 10px 20px; margin: 0 5px; border-radius: 8px; transition: var(--transition); }
        .nav-link:hover { color: white; background: rgba(255, 255, 255, 0.1); }
        .nav-link.active { color: white; background: var(--primary-color); box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
        
        /* STATS CARDS */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 25px; margin-bottom: 30px; }
        .stat-card { background: white; border-radius: 16px; padding: 25px; box-shadow: var(--card-shadow); transition: var(--transition); display: flex; align-items: center; border: 1px solid rgba(0,0,0,0.02); }
        .stat-card:hover { transform: translateY(-5px); }
        .stat-icon { width: 70px; height: 70px; border-radius: 16px; display: flex; align-items: center; justify-content: center; font-size: 30px; color: white; margin-right: 20px; flex-shrink: 0; }
        .stat-icon.total { background: linear-gradient(135deg, var(--primary-color), var(--primary-dark)); }
        .stat-icon.safe { background: linear-gradient(135deg, var(--success-color), #1d6f65); }
        .stat-icon.warning { background: linear-gradient(135deg, var(--warning-color), #d4a82d); }
        .stat-icon.danger { background: linear-gradient(135deg, var(--danger-color), #c95438); }
        .stat-value { font-size: 2.2rem; font-weight: 700; color: var(--secondary-color); line-height: 1; }
        .stat-label { color: #666; font-size: 0.9rem; margin-top: 5px; text-transform: uppercase; font-weight: 600; letter-spacing: 0.5px; }

        /* GENERAL CARDS */
        .card { border: none; border-radius: 16px; box-shadow: var(--card-shadow); margin-bottom: 25px; background: white; overflow: hidden; }
        .card-header { background: white; border-bottom: 1px solid #eee; padding: 20px 25px; font-weight: 700; font-size: 1.1rem; color: var(--secondary-color); display: flex; justify-content: space-between; align-items: center; }
        
        /* ANALYTICS */
        .analytics-card { background: white; border-radius: 16px; padding: 20px; box-shadow: var(--card-shadow); height: 100%; }
        
        /* MAP */
        #gov-map { height: 600px; width: 100%; z-index: 1; }
        
        /* ALERTS */
        .alert-card { padding: 15px; border-radius: 8px; border-left: 5px solid; background: #fff; margin-bottom: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        .alert-card.critical { border-left-color: var(--danger-color); background: #fff5f5; }
        .alert-card.complaint { border-left-color: var(--warning-color); background: #fffdf0; }
        
        /* BADGES */
        .status-badge { padding: 6px 15px; border-radius: 50px; font-size: 0.85rem; font-weight: 600; }
        .status-badge.safe { background: rgba(42, 157, 143, 0.15); color: #1d6f65; }
        .status-badge.warning { background: rgba(233, 196, 106, 0.15); color: #b38f1d; }
        .status-badge.critical { background: rgba(231, 111, 81, 0.15); color: #c95438; }
    </style>
</head>
<body>

    <!-- HEADER -->
    <header class="dashboard-header">
        <div class="container-fluid px-5">
            <div class="d-flex justify-content-between align-items-center">
                <div class="d-flex align-items-center">
                    <div class="logo-text">
                        <i class="fas fa-recycle me-2"></i>Zero<span class="logo-highlight">Overflow</span> AI
                    </div>
                    <span class="admin-badge">Govt. Admin</span>
                </div>
                <div>
                    <ul class="nav nav-pills" id="nav-tab" role="tablist">
                        <li class="nav-item">
                            <button class="nav-link active" id="dashboard-tab" data-bs-toggle="tab" data-bs-target="#dashboard">
                                <i class="fas fa-chart-pie me-2"></i> Dashboard
                            </button>
                        </li>
                        <li class="nav-item">
                            <button class="nav-link" id="map-tab" data-bs-toggle="tab" data-bs-target="#map">
                                <i class="fas fa-map-marked-alt me-2"></i> Map Command
                            </button>
                        </li>
                        <li class="nav-item">
                            <button class="nav-link" id="analytics-tab" data-bs-toggle="tab" data-bs-target="#analytics">
                                <i class="fas fa-chart-line me-2"></i> Analytics
                            </button>
                        </li>
                        <li class="nav-item">
                            <button class="nav-link" id="alerts-tab" data-bs-toggle="tab" data-bs-target="#alerts">
                                <i class="fas fa-bell me-2"></i> Alerts 
                                {% if pending_complaints.count > 0 %}<span class="badge bg-danger ms-2">{{ pending_complaints.count }}</span>{% endif %}
                            </button>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </header>

    <!-- MAIN CONTENT -->
    <main class="container-fluid px-5 py-4">
        <div class="tab-content">
            
            <!-- 1. DASHBOARD OVERVIEW -->
            <div class="tab-pane fade show active page-content" id="dashboard">
                <h2 class="fw-bold text-secondary mb-1">System Overview</h2>
                <p class="text-muted mb-4">Real-time status of {{ total_count }} units across 5 operational zones.</p>

                <!-- STATS CARDS -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon total"><i class="fas fa-trash-alt"></i></div>
                        <div><div class="stat-value">{{ total_count }}</div><div class="stat-label">Total Units</div></div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon safe"><i class="fas fa-check-circle"></i></div>
                        <div><div class="stat-value">{{ safe_count }}</div><div class="text-muted">Operational</div></div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon warning"><i class="fas fa-exclamation-triangle"></i></div>
                        <div><div class="stat-value">{{ warning_count }}</div><div class="text-muted">Warnings</div></div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon danger"><i class="fas fa-radiation-alt"></i></div>
                        <div><div class="stat-value">{{ critical_count }}</div><div class="text-muted">Critical</div></div>
                    </div>
                </div>

                <div class="row">
                    <!-- CHART -->
                    <div class="col-lg-8">
                        <div class="card h-100">
                            <div class="card-header">
                                <span><i class="fas fa-chart-bar me-2"></i>Zone Analysis (Top Critical)</span>
                            </div>
                            <div class="card-body">
                                <div style="height: 350px;"><canvas id="overviewChart"></canvas></div>
                            </div>
                        </div>
                    </div>
                    <!-- ALERTS SIDEBAR -->
                    <div class="col-lg-4">
                        <div class="card h-100">
                            <div class="card-header bg-danger text-white">
                                <span><i class="fas fa-bell me-2"></i>Priority Alerts</span>
                            </div>
                            <div class="card-body p-3" style="max-height: 400px; overflow-y: auto; background: #fafafa;">
                                {% for c in pending_complaints %}
                                <div class="alert-card complaint">
                                    <div class="d-flex align-items-center mb-2">
                                        <i class="fas fa-user-circle text-warning fs-4 me-2"></i>
                                        <div>
                                            <h6 class="mb-0 fw-bold">Citizen Report</h6>
                                            <small class="text-muted">{{ c.location }}</small>
                                        </div>
                                    </div>
                                    <p class="small mb-2 fst-italic">"{{ c.description }}"</p>
                                    <a href="{% url 'resolve_complaint' c.id %}" class="btn btn-success btn-sm w-100">Mark Resolved</a>
                                </div>
                                {% endfor %}
                                {% for bin in critical_bins %}
                                <div class="alert-card critical">
                                    <div class="d-flex align-items-center">
                                        <i class="fas fa-exclamation-circle text-danger fs-4 me-2"></i>
                                        <div>
                                            <h6 class="mb-0 fw-bold">Critical Level</h6>
                                            <div class="small">{{ bin.location }} - <span class="text-danger fw-bold">{{ bin.fill_level }}%</span></div>
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                                {% if pending_complaints.count == 0 and critical_bins.count == 0 %}
                                    <div class="text-center text-muted py-4"><p>No active alerts.</p></div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- BIN TABLE -->
                <div class="card mt-4">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <span>Recent Bin Status</span>
                        <button class="btn btn-sm btn-outline-primary">View All</button>
                    </div>
                    <div class="card-body">
                        <div class="table-container">
                            <table class="table table-hover">
                                <thead>
                                    <tr><th>Bin ID</th><th>Location</th><th>Fill Level</th><th>Last Emptied</th><th>Status</th></tr>
                                </thead>
                                <tbody id="bin-table-body">
                                    <!-- Populated via JS -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 2. MAP VIEW -->
            <div class="tab-pane fade" id="map">
                <div class="row">
                    <div class="col-lg-9 p-0">
                        <div class="card m-0" style="border-radius: 0;"><div id="gov-map"></div></div>
                    </div>
                    <div class="col-lg-3 bg-white border-start p-4">
                        <h4 class="fw-bold mb-4 text-secondary">Map Command</h4>
                        <label class="form-label fw-bold">Select Zone</label>
                        <select class="form-select mb-4" id="cityFilter">
                            <option value="all">Show All Zones</option>
                            <option value="Noida">Noida Zone</option>
                            <option value="Ghaziabad">Ghaziabad Zone</option>
                            <option value="Janakpuri">Janakpuri Zone</option>
                            <option value="Dwarka">Dwarka Zone</option>
                            <option value="Gurugram">Gurugram Zone</option>
                        </select>
                        <div class="card p-3 bg-light border-0 mb-4">
                            <h6 class="fw-bold mb-3">Legend</h6>
                            <div class="d-flex align-items-center mb-2"><i class="fas fa-circle text-danger me-2"></i> Critical (>80%)</div>
                            <div class="d-flex align-items-center mb-2"><i class="fas fa-circle text-warning me-2"></i> Warning (50-80%)</div>
                            <div class="d-flex align-items-center"><i class="fas fa-circle text-success me-2"></i> Safe (<50%)</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 3. ANALYTICS VIEW -->
            <div class="tab-pane fade" id="analytics">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2 class="fw-bold text-secondary mb-0">System Analytics</h2>
                    <button class="btn btn-outline-secondary" onclick="window.print()"><i class="fas fa-download me-2"></i>Generate Report</button>
                </div>

                <div class="row mb-4">
                    <!-- Trends Chart -->
                    <div class="col-lg-8">
                        <div class="analytics-card">
                            <h5 class="fw-bold mb-3 text-secondary">Weekly Fill Level Trends</h5>
                            <div style="height: 300px;"><canvas id="trendsChart"></canvas></div>
                        </div>
                    </div>
                    <!-- Efficiency Chart -->
                    <div class="col-lg-4">
                        <div class="analytics-card">
                            <h5 class="fw-bold mb-3 text-secondary">Collection Efficiency</h5>
                            <div style="height: 300px;"><canvas id="efficiencyChart"></canvas></div>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <!-- Overflow Prediction -->
                    <div class="col-lg-6">
                        <div class="analytics-card">
                            <h5 class="fw-bold mb-3 text-secondary">Overflow Forecast (Next 24h)</h5>
                            <div style="height: 300px;"><canvas id="predictionChart"></canvas></div>
                        </div>
                    </div>
                    <!-- Zone Analysis (FIXED) -->
                    <div class="col-lg-6">
                        <div class="analytics-card">
                            <h5 class="fw-bold mb-3 text-secondary">Average Fill Level by Zone</h5>
                            <div style="height: 300px;"><canvas id="locationChart"></canvas></div>
                        </div>
                    </div>
                </div>
            </div>

                        <!-- 4. TASK & INCIDENT MANAGEMENT TAB -->
            <div class="tab-pane fade" id="alerts" role="tabpanel">
                
                <!-- Section Header -->
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2 class="fw-bold text-secondary mb-0">Task & Incident Management</h2>
                    <button class="btn btn-outline-secondary" onclick="location.reload()">
                        <i class="fas fa-sync-alt me-2"></i>Refresh Data
                    </button>
                </div>

                <!-- SUMMARY CARDS (Counts) -->
                <div class="row mb-4">
                    <!-- Pending -->
                    <div class="col-md-4">
                        <div class="card p-3 shadow-sm border-0" style="border-left: 5px solid #ffc107;">
                            <h5 class="text-muted text-uppercase fs-6 fw-bold">Pending Tasks</h5>
                            <h2 class="text-warning fw-bold">{{ pending_complaints.count }}</h2>
                        </div>
                    </div>
                    <!-- In Progress -->
                    <div class="col-md-4">
                        <div class="card p-3 shadow-sm border-0" style="border-left: 5px solid #0dcaf0;">
                            <h5 class="text-muted text-uppercase fs-6 fw-bold">In Progress</h5>
                            <h2 class="text-info fw-bold">{{ progress_count }}</h2>
                        </div>
                    </div>
                    <!-- Resolved -->
                    <div class="col-md-4">
                        <div class="card p-3 shadow-sm border-0" style="border-left: 5px solid #198754;">
                            <h5 class="text-muted text-uppercase fs-6 fw-bold">Resolved</h5>
                            <h2 class="text-success fw-bold">{{ resolved_count }}</h2>
                        </div>
                    </div>
                </div>

                <!-- ACTION TABLE -->
                <div class="card p-0">
                    <div class="card-header bg-dark text-white">
                        <i class="fas fa-tasks me-2"></i> Active Incident Registry
                    </div>
                    <div class="card-body p-0">
                        <table class="table table-hover align-middle mb-0">
                            <thead class="bg-light">
                                <tr>
                                    <th class="py-3 ps-4">ID</th>
                                    <th class="py-3">Issue Type</th>
                                    <th class="py-3">Location & Details</th>
                                    <th class="py-3">Current Status</th>
                                    <th class="py-3 text-end pe-4">Take Action</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for c in recent_complaints %}
                                <tr>
                                    <td class="ps-4 fw-bold">#{{ c.id }}</td>
                                    <td>
                                        <span class="badge bg-light text-dark border">
                                            {{ c.get_complaint_type_display }}
                                        </span>
                                    </td>
                                    <td>
                                        <div class="fw-bold">{{ c.location }}</div>
                                        <small class="text-muted fst-italic">"{{ c.description }}"</small>
                                    </td>
                                    <td>
                                        <!-- STATUS BADGES -->
                                        {% if c.status == 'pending' %}
                                            <span class="badge bg-warning text-dark px-3 py-2 rounded-pill">Pending</span>
                                        {% elif c.status == 'acknowledged' %}
                                            <span class="badge bg-info text-dark px-3 py-2 rounded-pill">In Progress</span>
                                        {% elif c.status == 'resolved' %}
                                            <span class="badge bg-success px-3 py-2 rounded-pill">Completed</span>
                                        {% endif %}
                                    </td>
                                    <td class="text-end pe-4">
                                        <!-- ACTION BUTTONS -->
                                        {% if c.status == 'pending' %}
                                            <!-- Step 1: Start Task -->
                                            <a href="{% url 'update_status' c.id 'progress' %}" class="btn btn-sm btn-outline-info me-1" title="Dispatch Team">
                                                <i class="fas fa-truck"></i> Start
                                            </a>
                                            <!-- Direct Complete -->
                                            <a href="{% url 'update_status' c.id 'resolved' %}" class="btn btn-sm btn-success" title="Mark Done">
                                                <i class="fas fa-check"></i>
                                            </a>
                                        {% elif c.status == 'acknowledged' %}
                                            <!-- Step 2: Mark Complete -->
                                            <a href="{% url 'update_status' c.id 'resolved' %}" class="btn btn-sm btn-success">
                                                <i class="fas fa-check"></i> Mark Complete
                                            </a>
                                        {% else %}
                                            <span class="text-muted small"><i class="fas fa-lock"></i> Closed</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
    </main>

    <!-- FOOTER -->
    <footer class="bg-dark text-white py-3 mt-auto">
        <div class="container text-center"><small>&copy; 2024 ZeroOverflow AI - Authorized Personnel Only</small></div>
    </footer>

    <!-- SCRIPTS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        // --- 1. DATA INJECTION ---
        const cityCoords = {
            'Noida': {lat: 28.5355, lng: 77.3910}, 'Ghaziabad': {lat: 28.6692, lng: 77.4538},
            'Janakpuri': {lat: 28.6219, lng: 77.0878}, 'Dwarka': {lat: 28.5921, lng: 77.0460},
            'Gurugram': {lat: 28.4595, lng: 77.0266}
        };

        const binData = [
            {% for bin in bins %}
            {
                id: {{ bin.id }},
                location: "{{ bin.location }}",
                fillLevel: {{ bin.fill_level }},
                status: "{{ bin.status }}",
                lastEmptied: "{{ bin.last_emptied|timesince }} ago"
            },
            {% endfor %}
        ];

        // Assign Lat/Lng based on Location String
        binData.forEach(bin => {
            let baseLat = 28.6139; let baseLng = 77.2090; 
            if(bin.location.includes('Noida')) { baseLat = cityCoords['Noida'].lat; baseLng = cityCoords['Noida'].lng; }
            else if(bin.location.includes('Ghaziabad')) { baseLat = cityCoords['Ghaziabad'].lat; baseLng = cityCoords['Ghaziabad'].lng; }
            else if(bin.location.includes('Janakpuri')) { baseLat = cityCoords['Janakpuri'].lat; baseLng = cityCoords['Janakpuri'].lng; }
            else if(bin.location.includes('Dwarka')) { baseLat = cityCoords['Dwarka'].lat; baseLng = cityCoords['Dwarka'].lng; }
            else if(bin.location.includes('Gurugram')) { baseLat = cityCoords['Gurugram'].lat; baseLng = cityCoords['Gurugram'].lng; }
            bin.lat = baseLat + (Math.random() * 0.04) - 0.02;
            bin.lng = baseLng + (Math.random() * 0.04) - 0.02;
        });

        // --- 2. MAP LOGIC ---
        var map = null; var markersLayer = new L.LayerGroup(); 
        function initMap() {
            if (map) return;
            map = L.map('gov-map').setView([28.6139, 77.2090], 10);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
            markersLayer.addTo(map);
            updateMapMarkers('all');
        }
        function updateMapMarkers(filterCity) {
            markersLayer.clearLayers(); 
            binData.forEach(bin => {
                if (filterCity === 'all' || bin.location.includes(filterCity)) {
                    var color = bin.status === "critical" ? "red" : bin.status === "warning" ? "orange" : "green";
                    var marker = L.circleMarker([bin.lat, bin.lng], { color: color, fillColor: color, fillOpacity: 0.8, radius: 8 }).bindPopup(`<b>${bin.location}</b><br>Fill: ${bin.fillLevel}%`);
                    markersLayer.addLayer(marker);
                }
            });
            if (filterCity !== 'all' && cityCoords[filterCity]) map.setView([cityCoords[filterCity].lat, cityCoords[filterCity].lng], 13);
            else map.setView([28.6139, 77.2090], 10);
        }
        document.getElementById('map-tab').addEventListener('shown.bs.tab', () => { initMap(); setTimeout(() => { map.invalidateSize(); }, 100); });
        document.getElementById('cityFilter').addEventListener('change', function() { updateMapMarkers(this.value); });

        // --- 3. OVERVIEW CHART ---
        document.addEventListener('DOMContentLoaded', function() {
            renderBinTable(); // Load Table on Start
            const ctx = document.getElementById('overviewChart').getContext('2d');
            const criticalBins = binData.filter(b => b.fillLevel > 50).slice(0, 15);
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: criticalBins.map(b => b.location.split('-')[1] || b.location),
                    datasets: [{
                        label: 'Fill Level (%)',
                        data: criticalBins.map(b => b.fillLevel),
                        backgroundColor: criticalBins.map(b => b.fillLevel > 80 ? '#e76f51' : '#e9c46a'),
                        borderRadius: 4
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, max: 100 } } }
            });
        });

        function renderBinTable() {
            const tbody = document.getElementById('bin-table-body');
            tbody.innerHTML = '';
            binData.slice(0, 10).forEach(bin => {
                let badgeClass = bin.status === 'safe' ? 'safe' : bin.status === 'warning' ? 'warning' : 'danger';
                tbody.innerHTML += `
                    <tr>
                        <td><strong>#${bin.id}</strong></td>
                        <td>${bin.location}</td>
                        <td>
                            <div class="d-flex align-items-center">
                                <div class="progress flex-grow-1" style="height: 6px;"><div class="progress-bar bg-${badgeClass === 'danger' ? 'danger' : badgeClass === 'warning' ? 'warning' : 'success'}" style="width: ${bin.fillLevel}%"></div></div>
                                <span class="ms-2 small">${bin.fillLevel}%</span>
                            </div>
                        </td>
                        <td>${bin.lastEmptied}</td>
                        <td><span class="status-badge ${badgeClass}">${bin.status}</span></td>
                    </tr>
                `;
            });
        }

        // --- 4. ANALYTICS CHARTS ---
        document.getElementById('analytics-tab').addEventListener('shown.bs.tab', function () {
            // Efficiency
            new Chart(document.getElementById('efficiencyChart'), {
                type: 'doughnut',
                data: { labels: ['Efficient', 'Critical'], datasets: [{ data: [{{ safe_count }}, {{ critical_count }}], backgroundColor: ['#2a9d8f', '#e76f51'] }] },
                options: { plugins: { legend: { position: 'bottom' } } }
            });

            // Prediction
            const risk4h = binData.filter(b => b.fillLevel >= 90).length;
            const risk8h = binData.filter(b => b.fillLevel >= 75 && b.fillLevel < 90).length;
            const risk12h = binData.filter(b => b.fillLevel >= 60 && b.fillLevel < 75).length;
            const risk24h = binData.filter(b => b.fillLevel >= 50 && b.fillLevel < 60).length;
            new Chart(document.getElementById('predictionChart'), {
                type: 'bar',
                data: { labels: ['+4h', '+8h', '+12h', '+24h'], datasets: [{ label: 'Predicted Overflows', data: [risk4h, risk8h, risk12h, risk24h], backgroundColor: '#264653' }] }
            });

            // Zone Analysis (FIXED LOGIC - Average Fill %)
            const zones = ['Noida', 'Ghaziabad', 'Janakpuri', 'Dwarka', 'Gurugram'];
            const zoneData = zones.map(z => {
                const cityBins = binData.filter(b => b.location.includes(z));
                if (cityBins.length === 0) return 0;
                const total = cityBins.reduce((sum, b) => sum + b.fillLevel, 0);
                return Math.round(total / cityBins.length);
            });
            new Chart(document.getElementById('locationChart'), {
                type: 'bar',
                data: { labels: zones, datasets: [{ label: 'Avg Zone Fill %', data: zoneData, backgroundColor: zoneData.map(v => v>70?'#e76f51':v>50?'#e9c46a':'#2a9d8f') }] },
                options: { scales: { y: { beginAtZero: true, max: 100 } }, plugins: { legend: { display: false } } }
            });

            // Trends (Simulated)
            new Chart(document.getElementById('trendsChart'), {
                type: 'line',
                data: { labels: ['Mon','Tue','Wed','Thu','Fri','Sat','Today'], datasets: [{ label: 'Avg Fill Level', data: [45,52,48,61,58,65,{{ total_count }}], borderColor: '#2a9d8f', fill: true }] },
                options: { responsive: true, maintainAspectRatio: false }
            });
        });
    </script>
</body>
</html>